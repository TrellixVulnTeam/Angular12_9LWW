import * as olstyle from 'ol/style';
import OlLineString from 'ol/geom/LineString';
import OlPolygon from 'ol/geom/Polygon';
import OlGeoJSON from 'ol/format/GeoJSON';
import lineIntersect from '@turf/line-intersect';
import { lineString } from '@turf/helpers';
import { GeometrySliceMultiPolygonError, GeometrySliceLineStringError, GeometrySliceTooManyIntersectionError } from './geometry.errors';
/**
 * Create a default style for draw and modify interactions
 * @param color Style color (R, G, B)
 * @returns OL style
 */
export function createDrawInteractionStyle(color) {
    color = color || [0, 153, 255];
    return new olstyle.Circle({
        stroke: new olstyle.Stroke({
            color: color.concat([1]),
            width: 2
        }),
        fill: new olstyle.Fill({
            color: color.concat([0.2])
        }),
        radius: 8
    });
}
/**
 * Create a default style for drawing a hole
 * @returns OL style
 */
export function createDrawHoleInteractionStyle() {
    return new olstyle.Style({
        stroke: new olstyle.Stroke({
            color: [0, 153, 255, 1],
            width: 2
        })
    });
}
/**
 * Slice geometry into two parts
 * @param olGeometry OL geometry
 * @param olSlicer Slicing line
 * @returns New OL geometries
 */
export function sliceOlGeometry(olGeometry, olSlicer) {
    if (olGeometry instanceof OlPolygon) {
        return sliceOlPolygon(olGeometry, olSlicer);
    }
    else if (olGeometry instanceof OlLineString) {
        return sliceOlLineString(olGeometry, olSlicer);
    }
    return [];
}
/**
 * Slice OL LineString into one or more lines
 * @param olLineString OL line string
 * @param olSlicer Slicing line
 * @returns New OL line strings
 */
export function sliceOlLineString(olLineString, olSlicer) {
    return [];
}
/**
 * Slice OL Polygon into one or more polygons
 * @param olPolygon OL polygon
 * @param olSlicer Slicing line
 * @returns New OL polygons
 */
export function sliceOlPolygon(olPolygon, olSlicer) {
    if (olPolygon.getLinearRingCount() > 1) {
        throw new GeometrySliceMultiPolygonError();
    }
    if (olSlicer.getCoordinates().length > 2) {
        throw new GeometrySliceLineStringError();
    }
    const olGeoJSON = new OlGeoJSON();
    const slicer = olGeoJSON.writeGeometryObject(olSlicer);
    const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();
    const parts = [[], []];
    let totalIntersectionCount = 0;
    for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {
        const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];
        const segment = lineString(segmentCoordinates);
        const intersections = lineIntersect(segment, slicer).features;
        const intersectionCount = intersections.length;
        totalIntersectionCount += intersectionCount;
        if (intersectionCount > 1 || totalIntersectionCount > 2) {
            throw new GeometrySliceTooManyIntersectionError();
        }
        parts[0].push(segmentCoordinates[0]);
        if (intersectionCount === 1) {
            const intersection = intersections[0].geometry.coordinates;
            parts[0].push(intersection);
            parts[1].push(intersection);
            parts.reverse();
        }
    }
    if (totalIntersectionCount <= 1) {
        return [];
    }
    parts[0].push(parts[0][0]);
    parts[1].push(parts[1][0]);
    return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];
}
/**
 * Splice geometry into two parts
 * @param olGeometry OL geometry
 * @param olSlicer Slicing line
 * @returns New OL geometries
 */
export function addLinearRingToOlPolygon(olPolygon, olLinearRing) {
    // TODO: make some validation and support updating an existing linear ring
    olPolygon.appendLinearRing(olLinearRing);
}
export function getMousePositionFromOlGeometryEvent(olEvent) {
    const olGeometry = olEvent.target;
    if (olGeometry instanceof OlPolygon) {
        return olGeometry.getFlatCoordinates().slice(-4, -2);
    }
    const olGeometryCast = olGeometry;
    return olGeometryCast.getFlatCoordinates().slice(-2);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvbWV0cnkudXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9nZW8vc3JjL2xpYi9nZW9tZXRyeS9zaGFyZWQvZ2VvbWV0cnkudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxLQUFLLE9BQU8sTUFBTSxVQUFVLENBQUM7QUFDcEMsT0FBTyxZQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFFOUMsT0FBTyxTQUFTLE1BQU0saUJBQWlCLENBQUM7QUFFeEMsT0FBTyxTQUFTLE1BQU0sbUJBQW1CLENBQUM7QUFDMUMsT0FBTyxhQUFhLE1BQU0sc0JBQXNCLENBQUM7QUFDakQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQ0wsOEJBQThCLEVBQzlCLDRCQUE0QixFQUM1QixxQ0FBcUMsRUFDckMsTUFBTSxtQkFBbUIsQ0FBQztBQUU1Qjs7OztHQUlHO0FBQ0gsTUFBTSxVQUFVLDBCQUEwQixDQUFDLEtBQWdDO0lBQ3pFLEtBQUssR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3hCLE1BQU0sRUFBRSxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDekIsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QixLQUFLLEVBQUUsQ0FBQztTQUNULENBQUM7UUFDRixJQUFJLEVBQUcsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3RCLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDM0IsQ0FBQztRQUNGLE1BQU0sRUFBRSxDQUFDO0tBQ1YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVEOzs7R0FHRztBQUNILE1BQU0sVUFB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J29sL2dlb20vQ2lyY2xlJztcbmltcG9ydCBPbFBvaW50IGZyb20gJ29sL2dlb20vUG9pbnQnO1xuaW1wb3J0IHR5cGUgeyBkZWZhdWx0IGFzIE9sR2VvbWV0cnkgfSBmcm9tICdvbC9nZW9tL0dlb21ldHJ5JztcbmltcG9ydCAqIGFzIG9sc3R5bGUgZnJvbSAnb2wvc3R5bGUnO1xuaW1wb3J0IE9sTGluZVN0cmluZyBmcm9tICdvbC9nZW9tL0xpbmVTdHJpbmcnO1xuaW1wb3J0IE9sTGluZWFyUmluZyBmcm9tICdvbC9nZW9tL0xpbmVhclJpbmcnO1xuaW1wb3J0IE9sUG9seWdvbiBmcm9tICdvbC9nZW9tL1BvbHlnb24nO1xuaW1wb3J0IEJhc2ljRXZlbnQgZnJvbSAnb2wvZXZlbnRzL0V2ZW50JztcbmltcG9ydCBPbEdlb0pTT04gZnJvbSAnb2wvZm9ybWF0L0dlb0pTT04nO1xuaW1wb3J0IGxpbmVJbnRlcnNlY3QgZnJvbSAnQHR1cmYvbGluZS1pbnRlcnNlY3QnO1xuaW1wb3J0IHsgbGluZVN0cmluZyB9IGZyb20gJ0B0dXJmL2hlbHBlcnMnO1xuXG5pbXBvcnQge1xuICBHZW9tZXRyeVNsaWNlTXVsdGlQb2x5Z29uRXJyb3IsXG4gIEdlb21ldHJ5U2xpY2VMaW5lU3RyaW5nRXJyb3IsXG4gIEdlb21ldHJ5U2xpY2VUb29NYW55SW50ZXJzZWN0aW9uRXJyb3JcbiB9IGZyb20gJy4vZ2VvbWV0cnkuZXJyb3JzJztcblxuLyoqXG4gKiBDcmVhdGUgYSBkZWZhdWx0IHN0eWxlIGZvciBkcmF3IGFuZCBtb2RpZnkgaW50ZXJhY3Rpb25zXG4gKiBAcGFyYW0gY29sb3IgU3R5bGUgY29sb3IgKFIsIEcsIEIpXG4gKiBAcmV0dXJucyBPTCBzdHlsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRHJhd0ludGVyYWN0aW9uU3R5bGUoY29sb3I/OiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0pOiBvbHN0eWxlLkNpcmNsZSB7XG4gIGNvbG9yID0gY29sb3IgfHwgWzAsIDE1MywgMjU1XTtcbiAgcmV0dXJuIG5ldyBvbHN0eWxlLkNpcmNsZSh7XG4gICAgc3Ryb2tlOiBuZXcgb2xzdHlsZS5TdHJva2Uoe1xuICAgICAgY29sb3I6IGNvbG9yLmNvbmNhdChbMV0pLFxuICAgICAgd2lkdGg6IDJcbiAgICB9KSxcbiAgICBmaWxsOiAgbmV3IG9sc3R5bGUuRmlsbCh7XG4gICAgICBjb2xvcjogY29sb3IuY29uY2F0KFswLjJdKVxuICAgIH0pLFxuICAgIHJhZGl1czogOFxuICB9KTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBkZWZhdWx0IHN0eWxlIGZvciBkcmF3aW5nIGEgaG9sZVxuICogQHJldHVybnMgT0wgc3R5bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURyYXdIb2xlSW50ZXJhY3Rpb25TdHlsZSgpOiBvbHN0eWxlLlN0eWxlIHtcbiAgcmV0dXJuIG5ldyBvbHN0eWxlLlN0eWxlKHtcbiAgICBzdHJva2U6IG5ldyBvbHN0eWxlLlN0cm9rZSh7XG4gICAgICBjb2xvcjogIFswLCAxNTMsIDI1NSwgMV0sXG4gICAgICB3aWR0aDogMlxuICAgIH0pXG4gIH0pO1xufVxuXG4vKipcbiAqIFNsaWNlIGdlb21ldHJ5IGludG8gdHdvIHBhcnRzXG4gKiBAcGFyYW0gb2xHZW9tZXRyeSBPTCBnZW9tZXRyeVxuICogQHBhcmFtIG9sU2xpY2VyIFNsaWNpbmcgbGluZVxuICogQHJldHVybnMgTmV3IE9MIGdlb21ldHJpZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNsaWNlT2xHZW9tZXRyeShcbiAgb2xHZW9tZXRyeTogT2xMaW5lU3RyaW5nIHwgT2xQb2x5Z29uLFxuICBvbFNsaWNlcjogT2xMaW5lU3RyaW5nXG4pOiBBcnJheTxPbExpbmVTdHJpbmcgfCBPbFBvbHlnb24+IHtcbiAgaWYgKG9sR2VvbWV0cnkgaW5zdGFuY2VvZiBPbFBvbHlnb24pIHtcbiAgICByZXR1cm4gc2xpY2VPbFBvbHlnb24ob2xHZW9tZXRyeSwgb2xTbGljZXIpO1xuICB9IGVsc2UgaWYgKG9sR2VvbWV0cnkgaW5zdGFuY2VvZiBPbExpbmVTdHJpbmcpIHtcbiAgICByZXR1cm4gc2xpY2VPbExpbmVTdHJpbmcob2xHZW9tZXRyeSwgb2xTbGljZXIpO1xuICB9XG4gIHJldHVybiBbXTtcbn1cblxuLyoqXG4gKiBTbGljZSBPTCBMaW5lU3RyaW5nIGludG8gb25lIG9yIG1vcmUgbGluZXNcbiAqIEBwYXJhbSBvbExpbmVTdHJpbmcgT0wgbGluZSBzdHJpbmdcbiAqIEBwYXJhbSBvbFNsaWNlciBTbGljaW5nIGxpbmVcbiAqIEByZXR1cm5zIE5ldyBPTCBsaW5lIHN0cmluZ3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNsaWNlT2xMaW5lU3RyaW5nKG9sTGluZVN0cmluZzogT2xMaW5lU3RyaW5nLCBvbFNsaWNlcjogT2xMaW5lU3RyaW5nKTogT2xMaW5lU3RyaW5nW10ge1xuICByZXR1cm4gW107XG59XG5cbi8qKlxuICogU2xpY2UgT0wgUG9seWdvbiBpbnRvIG9uZSBvciBtb3JlIHBvbHlnb25zXG4gKiBAcGFyYW0gb2xQb2x5Z29uIE9MIHBvbHlnb25cbiAqIEBwYXJhbSBvbFNsaWNlciBTbGljaW5nIGxpbmVcbiAqIEByZXR1cm5zIE5ldyBPTCBwb2x5Z29uc1xuICovXG5leHBvcnQgZnVuY3Rpb24gc2xpY2VPbFBvbHlnb24ob2xQb2x5Z29uOiBPbFBvbHlnb24sIG9sU2xpY2VyOiBPbExpbmVTdHJpbmcpOiBPbFBvbHlnb25bXSB7XG4gIGlmIChvbFBvbHlnb24uZ2V0TGluZWFyUmluZ0NvdW50KCkgPiAxKSB7XG4gICAgdGhyb3cgbmV3IEdlb21ldHJ5U2xpY2VNdWx0aVBvbHlnb25FcnJvcigpO1xuICB9XG5cbiAgaWYgKG9sU2xpY2VyLmdldENvb3JkaW5hdGVzKCkubGVuZ3RoID4gMikge1xuICAgIHRocm93IG5ldyBHZW9tZXRyeVNsaWNlTGluZVN0cmluZ0Vycm9yKCk7XG4gIH1cblxuICBjb25zdCBvbEdlb0pTT04gPSBuZXcgT2xHZW9KU09OKCk7XG4gIGNvbnN0IHNsaWNlciA9IG9sR2VvSlNPTi53cml0ZUdlb21ldHJ5T2JqZWN0KG9sU2xpY2VyKSBhcyBhbnk7XG4gIGNvbnN0IG91dGVyQ29vcmRpbmF0ZXMgPSBvbFBvbHlnb24uZ2V0TGluZWFyUmluZygwKS5nZXRDb29yZGluYXRlcygpO1xuXG4gIGNvbnN0IHBhcnRzID0gW1tdLCBbXV07XG4gIGxldCB0b3RhbEludGVyc2VjdGlvbkNvdW50ID0gMDtcbiAgZm9yIChsZXQgaSA9IDAsIGlpID0gb3V0ZXJDb29yZGluYXRlcy5sZW5ndGggLSAxOyBpIDwgaWk7IGkrKykge1xuICAgIGNvbnN0IHNlZ21lbnRDb29yZGluYXRlcyA9IFtvdXRlckNvb3JkaW5hdGVzW2ldLCBvdXRlckNvb3JkaW5hdGVzW2kgKyAxXV07XG4gICAgY29uc3Qgc2VnbWVudCA9IGxpbmVTdHJpbmcoc2VnbWVudENvb3JkaW5hdGVzKTtcbiAgICBjb25zdCBpbnRlcnNlY3Rpb25zID0gbGluZUludGVyc2VjdChzZWdtZW50LCBzbGljZXIpLmZlYXR1cmVzO1xuXG4gICAgY29uc3QgaW50ZXJzZWN0aW9uQ291bnQgPSBpbnRlcnNlY3Rpb25zLmxlbmd0aDtcbiAgICB0b3RhbEludGVyc2VjdGlvbkNvdW50ICs9IGludGVyc2VjdGlvbkNvdW50O1xuICAgIGlmIChpbnRlcnNlY3Rpb25Db3VudCA+IDEgfHwgdG90YWxJbnRlcnNlY3Rpb25Db3VudCA+IDIpIHtcbiAgICAgIHRocm93IG5ldyBHZW9tZXRyeVNsaWNlVG9vTWFueUludGVyc2VjdGlvbkVycm9yKCk7XG4gICAgfVxuXG4gICAgcGFydHNbMF0ucHVzaChzZWdtZW50Q29vcmRpbmF0ZXNbMF0pO1xuICAgIGlmIChpbnRlcnNlY3Rpb25Db3VudCA9PT0gMSkge1xuICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gaW50ZXJzZWN0aW9uc1swXS5nZW9tZXRyeS5jb29yZGluYXRlcztcbiAgICAgIHBhcnRzWzBdLnB1c2goaW50ZXJzZWN0aW9uKTtcbiAgICAgIHBhcnRzWzFdLnB1c2goaW50ZXJzZWN0aW9uKTtcbiAgICAgIHBhcnRzLnJldmVyc2UoKTtcbiAgICB9XG4gIH1cblxuICBpZiAodG90YWxJbnRlcnNlY3Rpb25Db3VudCA8PSAxKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgcGFydHNbMF0ucHVzaChwYXJ0c1swXVswXSk7XG4gIHBhcnRzWzFdLnB1c2gocGFydHNbMV1bMF0pO1xuXG4gIHJldHVybiBbbmV3IE9sUG9seWdvbihbcGFydHNbMF1dKSwgbmV3IE9sUG9seWdvbihbcGFydHNbMV1dKV07XG59XG5cbi8qKlxuICogU3BsaWNlIGdlb21ldHJ5IGludG8gdHdvIHBhcnRzXG4gKiBAcGFyYW0gb2xHZW9tZXRyeSBPTCBnZW9tZXRyeVxuICogQHBhcmFtIG9sU2xpY2VyIFNsaWNpbmcgbGluZVxuICogQHJldHVybnMgTmV3IE9MIGdlb21ldHJpZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGFkZExpbmVhclJpbmdUb09sUG9seWdvbihvbFBvbHlnb246IE9sUG9seWdvbiwgb2xMaW5lYXJSaW5nOiBPbExpbmVhclJpbmcgKSB7XG4gIC8vIFRPRE86IG1ha2Ugc29tZSB2YWxpZGF0aW9uIGFuZCBzdXBwb3J0IHVwZGF0aW5nIGFuIGV4aXN0aW5nIGxpbmVhciByaW5nXG4gIG9sUG9seWdvbi5hcHBlbmRMaW5lYXJSaW5nKG9sTGluZWFyUmluZyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNb3VzZVBvc2l0aW9uRnJvbU9sR2VvbWV0cnlFdmVudChcbiAgb2xFdmVudDogQmFzaWNFdmVudFxuKSB7XG4gIGNvbnN0IG9sR2VvbWV0cnkgPSBvbEV2ZW50LnRhcmdldCBhcyBPbEdlb21ldHJ5O1xuICBpZiAob2xHZW9tZXRyeSBpbnN0YW5jZW9mIE9sUG9seWdvbikge1xuICAgIHJldHVybiBvbEdlb21ldHJ5LmdldEZsYXRDb29yZGluYXRlcygpLnNsaWNlKC00LCAtMikgYXMgW251bWJlciwgbnVtYmVyXTtcbiAgfVxuICBjb25zdCBvbEdlb21ldHJ5Q2FzdCA9IG9sR2VvbWV0cnkgYXMgT2xQb2ludCB8IE9sTGluZVN0cmluZyB8IE9sQ2lyY2xlO1xuICByZXR1cm4gb2xHZW9tZXRyeUNhc3QuZ2V0RmxhdENvb3JkaW5hdGVzKCkuc2xpY2UoLTIpIGFzIFtudW1iZXIsIG51bWJlcl07XG59XG4iXX0=