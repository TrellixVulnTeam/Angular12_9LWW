import { StringUtils } from './string-utils';
import { ChangeType } from './change.interface';
export class ChangeUtils {
    static findChanges(obj1, obj2, ignoreKeys = []) {
        const items = {
            added: [],
            deleted: [],
            modified: []
        };
        if (!obj1 || !obj2) {
            return items;
        }
        const obj1Clone = [...obj1];
        const obj2Clone = [...obj2];
        for (const fromItem of obj1Clone) {
            const index = obj2Clone.findIndex(s => s.id === fromItem.id);
            if (index === -1) {
                items.deleted.push({
                    change: { type: ChangeType.DELETED },
                    value: fromItem
                });
                continue;
            }
            const toItem = obj2Clone.splice(index, 1)[0];
            const fromItemClone = JSON.parse(JSON.stringify(fromItem));
            const toItemClone = JSON.parse(JSON.stringify(toItem));
            const keysChanged = ChangeUtils.compareObject(fromItemClone, toItemClone, undefined, ignoreKeys);
            if (keysChanged.length) {
                items.modified.push({
                    change: {
                        type: ChangeType.MODIFIED,
                        keysChanged
                    },
                    value: fromItemClone,
                    oldValue: fromItem,
                    newValue: toItem
                });
            }
        }
        items.added = obj2Clone.map(itemAdded => {
            return {
                change: { type: ChangeType.ADDED },
                value: itemAdded
            };
        });
        return items;
    }
    static compareObject(fromItem, toItem, baseKey, ignoreKeys = []) {
        const fromItemClone = JSON.parse(JSON.stringify(fromItem));
        const toItemClone = JSON.parse(JSON.stringify(toItem));
        const keys = new Set([
            ...Object.keys(fromItem),
            ...Object.keys(toItem)
        ]);
        let keysChanged = [];
        keys.forEach(key => {
            const keyString = baseKey ? `${baseKey}.${key}` : key;
            if (ignoreKeys.indexOf(keyString) !== -1) {
                return;
            }
            if (Array.isArray(fromItem[key])) {
                fromItem[key] = fromItem[key].join(',<br>');
            }
            if (Array.isArray(toItem[key])) {
                toItem[key] = toItem[key].join(',<br>');
            }
            if (typeof fromItem[key] === 'object' &&
                typeof toItem[key] === 'object' &&
                fromItem[key] !== null &&
                toItem[key] !== null) {
                keysChanged = keysChanged.concat(this.compareObject(fromItem[key], toItem[key], keyString));
            }
            else {
                if (fromItem[key] !== toItem[key]) {
                    keysChanged.push({
                        key: keyString,
                        oldValue: fromItemClone[key],
                        newValue: toItemClone[key]
                    });
                    fromItem[key] = StringUtils.diff(fromItem[key], toItem[key]);
                }
            }
        });
        return keysChanged;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvdXRpbHMvc3JjL2xpYi9jaGFuZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBbUIsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFakUsTUFBTSxPQUFPLFdBQVc7SUFDdEIsTUFBTSxDQUFDLFdBQVcsQ0FDaEIsSUFBVyxFQUNYLElBQVcsRUFDWCxhQUF1QixFQUFFO1FBRXpCLE1BQU0sS0FBSyxHQUFvQjtZQUM3QixLQUFLLEVBQUUsRUFBRTtZQUNULE9BQU8sRUFBRSxFQUFFO1lBQ1gsUUFBUSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBRUYsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNsQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsTUFBTSxTQUFTLEdBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sU0FBUyxHQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUVqQyxLQUFLLE1BQU0sUUFBUSxJQUFJLFNBQVMsRUFBRTtZQUNoQyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFN0QsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNqQixNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLE9BQU8sRUFBRTtvQkFDcEMsS0FBSyxFQUFFLFFBQVE7aUJBQ2hCLENBQUMsQ0FBQztnQkFDSCxTQUFTO2FBQ1Y7WUFFRCxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFB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LFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUM5QixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQzFELENBQUM7YUFDSDtpQkFBTTtnQkFDTCxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUM7d0JBQ2YsR0FBRyxFQUFFLFNBQVM7d0JBQ2QsUUFBUSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUM7d0JBQzVCLFFBQVEsRUFBRSxXQUFXLENBQUMsR0FBRyxDQUFDO3FCQUMzQixDQUFDLENBQUM7b0JBQ0gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUM5RDthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdHJpbmdVdGlscyB9IGZyb20gJy4vc3RyaW5nLXV0aWxzJztcbmltcG9ydCB7IEdyb3VwaW5nQ2hhbmdlcywgQ2hhbmdlVHlwZSB9IGZyb20gJy4vY2hhbmdlLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjbGFzcyBDaGFuZ2VVdGlscyB7XG4gIHN0YXRpYyBmaW5kQ2hhbmdlcyhcbiAgICBvYmoxOiBhbnlbXSxcbiAgICBvYmoyOiBhbnlbXSxcbiAgICBpZ25vcmVLZXlzOiBzdHJpbmdbXSA9IFtdXG4gICk6IEdyb3VwaW5nQ2hhbmdlcyB7XG4gICAgY29uc3QgaXRlbXM6IEdyb3VwaW5nQ2hhbmdlcyA9IHtcbiAgICAgIGFkZGVkOiBbXSxcbiAgICAgIGRlbGV0ZWQ6IFtdLFxuICAgICAgbW9kaWZpZWQ6IFtdXG4gICAgfTtcblxuICAgIGlmICghb2JqMSB8fCAhb2JqMikge1xuICAgICAgcmV0dXJuIGl0ZW1zO1xuICAgIH1cblxuICAgIGNvbnN0IG9iajFDbG9uZTogYW55ID0gWy4uLm9iajFdO1xuICAgIGNvbnN0IG9iajJDbG9uZTogYW55ID0gWy4uLm9iajJdO1xuXG4gICAgZm9yIChjb25zdCBmcm9tSXRlbSBvZiBvYmoxQ2xvbmUpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gb2JqMkNsb25lLmZpbmRJbmRleChzID0+IHMuaWQgPT09IGZyb21JdGVtLmlkKTtcblxuICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICBpdGVtcy5kZWxldGVkLnB1c2goe1xuICAgICAgICAgIGNoYW5nZTogeyB0eXBlOiBDaGFuZ2VUeXBlLkRFTEVURUQgfSxcbiAgICAgICAgICB2YWx1ZTogZnJvbUl0ZW1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0b0l0ZW0gPSBvYmoyQ2xvbmUuc3BsaWNlKGluZGV4LCAxKVswXTtcbiAgICAgIGNvbnN0IGZyb21JdGVtQ2xvbmUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGZyb21JdGVtKSk7XG4gICAgICBjb25zdCB0b0l0ZW1DbG9uZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodG9JdGVtKSk7XG5cbiAgICAgIGNvbnN0IGtleXNDaGFuZ2VkID0gQ2hhbmdlVXRpbHMuY29tcGFyZU9iamVjdChcbiAgICAgICAgZnJvbUl0ZW1DbG9uZSxcbiAgICAgICAgdG9JdGVtQ2xvbmUsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgaWdub3JlS2V5c1xuICAgICAgKTtcblxuICAgICAgaWYgKGtleXNDaGFuZ2VkLmxlbmd0aCkge1xuICAgICAgICBpdGVtcy5tb2RpZmllZC5wdXNoKHtcbiAgICAgICAgICBjaGFuZ2U6IHtcbiAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuTU9ESUZJRUQsXG4gICAgICAgICAgICBrZXlzQ2hhbmdlZFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdmFsdWU6IGZyb21JdGVtQ2xvbmUsXG4gICAgICAgICAgb2xkVmFsdWU6IGZyb21JdGVtLFxuICAgICAgICAgIG5ld1ZhbHVlOiB0b0l0ZW1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaXRlbXMuYWRkZWQgPSBvYmoyQ2xvbmUubWFwKGl0ZW1BZGRlZCA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjaGFuZ2U6IHsgdHlwZTogQ2hhbmdlVHlwZS5BRERFRCB9LFxuICAgICAgICB2YWx1ZTogaXRlbUFkZGVkXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGl0ZW1zO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY29tcGFyZU9iamVjdChmcm9tSXRlbSwgdG9JdGVtLCBiYXNlS2V5PywgaWdub3JlS2V5cyA9IFtdKSB7XG4gICAgY29uc3QgZnJvbUl0ZW1DbG9uZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZnJvbUl0ZW0pKTtcbiAgICBjb25zdCB0b0l0ZW1DbG9uZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodG9JdGVtKSk7XG5cbiAgICBjb25zdCBrZXlzOiBhbnkgPSBuZXcgU2V0KFtcbiAgICAgIC4uLk9iamVjdC5rZXlzKGZyb21JdGVtKSxcbiAgICAgIC4uLk9iamVjdC5rZXlzKHRvSXRlbSlcbiAgICBdKTtcbiAgICBsZXQga2V5c0NoYW5nZWQgPSBbXTtcbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGNvbnN0IGtleVN0cmluZyA9IGJhc2VLZXkgPyBgJHtiYXNlS2V5fS4ke2tleX1gIDoga2V5O1xuICAgICAgaWYgKGlnbm9yZUtleXMuaW5kZXhPZihrZXlTdHJpbmcpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZyb21JdGVtW2tleV0pKSB7XG4gICAgICAgIGZyb21JdGVtW2tleV0gPSBmcm9tSXRlbVtrZXldLmpvaW4oJyw8YnI+Jyk7XG4gICAgICB9XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0b0l0ZW1ba2V5XSkpIHtcbiAgICAgICAgdG9JdGVtW2tleV0gPSB0b0l0ZW1ba2V5XS5qb2luKCcsPGJyPicpO1xuICAgICAgfVxuXG4gICAgICBpZiAoXG4gICAgICAgIHR5cGVvZiBmcm9tSXRlbVtrZXldID09PSAnb2JqZWN0JyAmJlxuICAgICAgICB0eXBlb2YgdG9JdGVtW2tleV0gPT09ICdvYmplY3QnICYmXG4gICAgICAgIGZyb21JdGVtW2tleV0gIT09IG51bGwgJiZcbiAgICAgICAgdG9JdGVtW2tleV0gIT09IG51bGxcbiAgICAgICkge1xuICAgICAgICBrZXlzQ2hhbmdlZCA9IGtleXNDaGFuZ2VkLmNvbmNhdChcbiAgICAgICAgICB0aGlzLmNvbXBhcmVPYmplY3QoZnJvbUl0ZW1ba2V5XSwgdG9JdGVtW2tleV0sIGtleVN0cmluZylcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChmcm9tSXRlbVtrZXldICE9PSB0b0l0ZW1ba2V5XSkge1xuICAgICAgICAgIGtleXNDaGFuZ2VkLnB1c2goe1xuICAgICAgICAgICAga2V5OiBrZXlTdHJpbmcsXG4gICAgICAgICAgICBvbGRWYWx1ZTogZnJvbUl0ZW1DbG9uZVtrZXldLFxuICAgICAgICAgICAgbmV3VmFsdWU6IHRvSXRlbUNsb25lW2tleV1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBmcm9tSXRlbVtrZXldID0gU3RyaW5nVXRpbHMuZGlmZihmcm9tSXRlbVtrZXldLCB0b0l0ZW1ba2V5XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBrZXlzQ2hhbmdlZDtcbiAgfVxufVxuIl19